# APIコール数削減の検討

## 現状の問題

現在のユーザー分析機能では、全チャンネル（2514チャンネル）からメッセージを取得してから、ユーザーIDでフィルタリングしています。これにより、以下の問題が発生しています：

- **大量のAPIコール**: 各チャンネルから全メッセージを取得するため、APIコール数が非常に多い
- **レート制限**: 頻繁にレート制限エラーが発生し、処理時間が長くなる
- **非効率**: ユーザーが投稿していないチャンネルからも全メッセージを取得している

## 改善案

### 1. Slack Search APIの活用

Slack Search API (`search.messages`) を使用することで、ユーザーIDでフィルタリングしたメッセージを直接取得できます。

**メリット**:

- APIコール数を大幅に削減（全チャンネル横断で1回のAPIコールで検索可能）
- レート制限の影響を最小化
- 処理時間の短縮

**デメリット**:

- **Search APIはBot Tokenでのみ利用可能**（User Tokenでは`not_allowed_token_type`エラーが発生）
- Search APIは有料プランでのみ利用可能な場合がある
- 検索結果の制限（最大100件/ページ）がある可能性
- スレッドの返信が含まれない可能性

**注意**: 現在の実装では、User Tokenを使用している場合、Search APIが使えないため自動的にフォールバック処理（全チャンネル横断方式）が実行されます。フォールバック処理は並列処理で実行されるため、処理時間は短縮されています。

**実装例**:

```go
params := slack.NewSearchParameters()
params.Query = fmt.Sprintf("from:%s", userID)
params.Count = 100
params.Page = 1

searchResults, err := api.SearchMessages(params)
```

### 2. slack-goライブラリのアップデート ✅

現在のバージョン: `v0.17.3`  
アップデート完了

**アップデートのメリット**:

- バグ修正
- パフォーマンス改善
- 新機能の利用

### 3. Go 1.25へのアップデート ✅

現在のバージョン: `go 1.25`  
アップデート完了

**アップデートのメリット**:

- DWARF v5によるデバッグ情報の最適化（自動適用）
- コンパイラとリンカーの最適化（自動適用）
- メモリ割り当ての最適化（容量指定を追加）
- `go vet`の新しいチェック機能

### 4. 並行処理の最適化 ✅

並行処理を導入し、処理時間を短縮しました。

**実装内容**:

- レート制限を考慮した並行数の制限（セマフォで最大10並行）
- リアクション情報補完処理の並列化
- フォールバック処理（全チャンネル横断）の並列化
- スレッド返信取得の並列化

### 5. メモリ割り当ての最適化 ✅

Go 1.25の最適化を活用し、メモリ割り当てを最適化しました。

**実装内容**:

- スライスとマップの容量を事前に推定して割り当て
- メモリ再割り当ての回数を削減
- パフォーマンスの向上

## 実装状況

### ✅ 完了した実装

1. **slack-goライブラリのアップデート** ✅
   - v0.16.0 → v0.17.3 にアップデート完了
   - テスト実行済み
   - 破壊的変更なし

2. **Search APIの実装** ✅
   - `FindByUser`メソッドをSearch APIベースに変更
   - フォールバック機能を実装（Search APIが使えない場合は既存の方法を使用）
   - リアクション情報とスレッド情報の補完機能を実装
   - レート制限対応を実装

3. **並行処理の最適化** ✅
   - リアクション情報補完処理の並列化（セマフォで最大10並行）
   - フォールバック処理（全チャンネル横断）の並列化
   - スレッド返信取得の並列化
   - レート制限を考慮した同時実行数の制限

4. **Go 1.25へのアップデート** ✅
   - go.modを1.25に更新
   - メモリ割り当ての最適化（容量指定を追加）
   - コンパイラとリンカーの最適化（自動適用）

### 🔄 今後の改善案

1. **リアクション情報取得の最適化** (中リスク)
   - 現在はチャンネルごとにメッセージを取得してリアクション情報を補完している
   - より効率的な方法を検討（キャッシュ、バッチ処理など）

2. **実験的機能の検討** (低リスク)
   - `GOEXPERIMENT=greenteagc`によるガベージコレクションの最適化（10-40%のオーバーヘッド削減の可能性）
   - `GOEXPERIMENT=jsonv2`によるJSON処理の最適化

## 参考リンク

- [Slack Search API Documentation](https://api.slack.com/methods/search.messages)
- [slack-go GitHub Repository](https://github.com/slack-go/slack)
- [Slack API Rate Limits](https://api.slack.com/docs/rate-limits)
